#!/bin/bash
set -e

trap "killall mongod" EXIT

cd $(dirname $0)

eval $(cat .env)

HOSTNAME=$HOST
PROTOCOL="${HOST_PROTOCOL:-$([ "$HTTPS" == "true" ] && echo "https:" || echo "http:")}"
PORT="${HOST_PORT:-$([ "$PROTOCOL" == "https:" ] && echo "$HTTPS_PORT" || echo "$PORT")}"
HOST=$HOST HOST_PROTOCOL=$PROTOCOL HOST_PORT=$PORT TEMPLATE_DIR=./templates/www OUTPUT_DIR=./data/www ./services/www/build

(mongod --dbpath services/mongodb/data/db) &

(redis-server /usr/local/etc/redis.conf) &

(cd client/admin; webpack -d --watch) &
(cd client/api; webpack -d --watch) &
(cd client/editor; webpack -d --watch) &
(cd client/overlay; webpack -d --watch) &

(NODE_ENV=development foreman start -f Procfile.dev)
