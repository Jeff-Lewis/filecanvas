files:
  "/opt/elasticbeanstalk/npm.vars" :
    mode: "000775"
    owner: root
    group: users
    content: |
      export NPM_CONFIG_LOGLEVEL=error
      export NODE_PATH=`ls -td /opt/elasticbeanstalk/node-install/node-* | head -1`/bin
      export PATH=$PATH:$NODE_PATH
  "/opt/elasticbeanstalk/hooks/appdeploy/pre/50npm.sh" :
    mode: "000775"
    owner: root
    group: users
    content: |
      #!/bin/bash

      function error_exit
      {
        eventHelper.py --msg "$1" --severity ERROR
        exit $2
      }

      # Load npm environment vars
      . /opt/elasticbeanstalk/npm.vars

      # Ensure persistent node_modules folder exists
      if [ ! -d "/var/node_modules" ]; then
        mkdir /var/node_modules
      fi

      # Link application node_modules folder to persistent node_modules folder
      if [ -d /tmp/deployment/application ]; then
        ln -s /var/node_modules /tmp/deployment/application/
      fi

      # Install npm modules
      OUT=$([ -d "/tmp/deployment/application" ] && cd /tmp/deployment/application && npm prune 2>&1 && npm install 2>&1) || error_exit "npm install failed: $OUT" $?
      echo $OUT
